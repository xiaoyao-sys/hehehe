name: L

on:
  schedule:
      # 工作日每隔30分钟检查一次（北京时间13:20开始）
    - cron: '20 5 * * 1-5'  # UTC 5:20 -> 北京时间13:20
    - cron: '50 5 * * 1-5'  # UTC 5:50 -> 北京时间13:50
    - cron: '20 6 * * 1-5'  # UTC 6:20 -> 北京时间14:20
    - cron: '30 6 * * 1-5'  # UTC 6:30 -> 北京时间14:30
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]
    paths:
      - 'final_lof_fund_scraper.py'
      - 'fund_limit_fetcher.py'
      - 'config.ini'

jobs:
  monitor-funds:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]
    
    steps:
    - name: Checkout代码
      uses: actions/checkout@v3
      
    - name: 设置Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: 检查文件结构
      run: |
        echo "当前目录内容:"
        ls -la
        echo "检查必要文件是否存在:"
        if [ -f "final_lof_fund_scraper.py" ]; then echo "✓ final_lof_fund_scraper.py 存在"; else echo "✗ final_lof_fund_scraper.py 不存在"; fi
        if [ -f "fund_limit_fetcher.py" ]; then echo "✓ fund_limit_fetcher.py 存在"; else echo "✗ fund_limit_fetcher.py 不存在"; fi
        if [ -f "config.ini" ]; then echo "✓ config.ini 存在"; else echo "✗ config.ini 不存在"; fi
        if [ -f "requirements.txt" ]; then echo "✓ requirements.txt 存在"; else echo "✗ requirements.txt 不存在"; fi
        
    - name: 安装依赖（多种尝试方法）
      run: |
        python -m pip install --upgrade pip
        
        # 方法1：尝试直接安装（如果失败则继续尝试其他方法）
        echo "方法1：尝试直接安装requirements.txt中的依赖..."
        pip install -r requirements.txt || {
          echo "方法1失败，尝试方法2..."
          
          # 方法2：逐个安装依赖包
          echo "方法2：逐个安装依赖包..."
          pip install requests || echo "requests安装失败"
          pip install beautifulsoup4 || echo "beautifulsoup4安装失败"
          pip install pandas || echo "pandas安装失败"
          pip install lxml || echo "lxml安装失败"
          pip install aiohttp>=3.8.0 || echo "aiohttp安装失败"
          pip install akshare>=1.16.0 || echo "akshare安装失败"
        }
        
    - name: 检查Python包安装
      run: |
        echo "检查已安装的Python包:"
        python -c "import requests; print('requests版本:', requests.__version__)" || echo "requests未正确安装"
        python -c "import bs4; print('beautifulsoup4版本:', bs4.__version__)" || echo "beautifulsoup4未正确安装"
        python -c "import akshare; print('akshare版本:', akshare.__version__)" || echo "akshare未正确安装"
        python -c "import pandas; print('pandas版本:', pandas.__version__)" || echo "pandas未正确安装"
        python -c "import aiohttp; print('aiohttp版本:', aiohttp.__version__)" || echo "aiohttp未正确安装"

    - name: 检查配置文件
      run: |
        if [ ! -f "config.ini" ]; then
          echo "错误: 找不到config.ini配置文件"
          exit 1
        fi
        echo "config.ini内容:"
        cat config.ini
        
    - name: 运行基金监控程序
      env:
        WECHAT_WEBHOOK_KEY: ${{ secrets.WECHAT_WEBHOOK_KEY }}
      run: |
        # 如果环境变量中有webhook key，则更新配置文件
        if [ -n "$WECHAT_WEBHOOK_KEY" ]; then
          echo "使用GitHub Secrets中的webhook key"
          sed -i "s/webhook_key = .*/webhook_key = $WECHAT_WEBHOOK_KEY/" config.ini
        else
          echo "使用config.ini文件中的webhook key"
        fi
        
        echo "运行前检查:"
        echo "当前目录内容:"
        ls -la
        
        # 执行主程序
        echo "开始执行基金监控程序..."
        python final_lof_fund_scraper.py
